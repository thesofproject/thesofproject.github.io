<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="759px" preserveAspectRatio="none" style="width:1066px;height:759px;" version="1.1" viewBox="0 0 1066 759" width="1066px" zoomAndPan="magnify"><defs><filter height="300%" id="f1qyth8cbm2pf7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#87CEFA" height="737.4766" style="stroke: #A1A1CA; stroke-width: 1.0;" width="62" x="19" y="4"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="36.5" y="17.4951">Host</text><rect fill="#ADD8E6" height="737.4766" style="stroke: #A1A1CA; stroke-width: 1.0;" width="661" x="226.5" y="4"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="543.5" y="17.4951">SOF</text><rect fill="#90EE90" height="737.4766" style="stroke: #A1A1CA; stroke-width: 1.0;" width="131" x="907.5" y="4"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="942" y="17.4951">Hardware</text><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="74.7031" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="295" y="118.6641"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="354.3516" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="295" y="275.0703"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="14" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="556" y="165.3672"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="14" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="556" y="305.4219"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="161.4063" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="556" y="437.6641"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="100.7031" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="817" y="484.3672"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="123.4063" style="stroke: #A1A1CA; stroke-width: 2.0;" width="640.5" x="13" y="77.9609"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="303" style="stroke: #A1A1CA; stroke-width: 2.0;" width="960" x="13" y="334.4219"/><rect fill="#FFFFFF" height="254.2969" style="stroke: none; stroke-width: 1.0;" width="960" x="13" y="383.125"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="48.7031" style="stroke: #A1A1CA; stroke-width: 2.0;" width="1031.5" x="13" y="681.7734"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="50" x2="50" y1="60.9609" y2="747.4766"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="299.5" x2="299.5" y1="60.9609" y2="747.4766"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="560.5" x2="560.5" y1="60.9609" y2="747.4766"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="821.5" x2="821.5" y1="60.9609" y2="747.4766"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="972.5" x2="972.5" y1="60.9609" y2="747.4766"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="31.6094" style="stroke: #33335B; stroke-width: 1.5;" width="50" x="23" y="24.3516"/><text fill="#33335B" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="30" y="45.8848">driver</text><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="31.6094" style="stroke: #33335B; stroke-width: 1.5;" width="135" x="230.5" y="24.3516"/><text fill="#33335B" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="121" x="237.5" y="45.8848">Core #0: Zephyr lib</text><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="31.6094" style="stroke: #33335B; stroke-width: 1.5;" width="161" x="478.5" y="24.3516"/><text fill="#33335B" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="485.5" y="45.8848">Zephyr Power Manager</text><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="31.6094" style="stroke: #33335B; stroke-width: 1.5;" width="119" x="760.5" y="24.3516"/><text fill="#33335B" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="767.5" y="45.8848">Zephyr SoC HAL</text><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="31.6094" style="stroke: #33335B; stroke-width: 1.5;" width="119" x="911.5" y="24.3516"/><text fill="#33335B" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="918.5" y="45.8848">Core #0: Control</text><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="74.7031" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="295" y="118.6641"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="354.3516" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="295" y="275.0703"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="14" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="556" y="165.3672"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="14" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="556" y="305.4219"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="161.4063" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="556" y="437.6641"/><rect fill="#FFFFFF" filter="url(#f1qyth8cbm2pf7)" height="100.7031" style="stroke: #F05772; stroke-width: 1.0;" width="10" x="817" y="484.3672"/><path d="M13,77.9609 L78,77.9609 L78,85.9609 L68,95.9609 L13,95.9609 L13,77.9609 " fill="#EEEEEE" style="stroke: #A1A1CA; stroke-width: 1.0;"/><rect fill="none" height="123.4063" style="stroke: #A1A1CA; stroke-width: 2.0;" width="640.5" x="13" y="77.9609"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="28" y="92.4561">opt</text><text fill="#33335B" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="93" y="91.3799">[If D0ix is enabled]</text><polygon fill="#F05772" points="283,114.6641,293,118.6641,283,122.6641,287,118.6641" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="50" x2="289" y1="118.6641" y2="118.6641"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="57" y="113.8076">SET_D0ix(prevent D0ix) IPC request</text><polygon fill="#F05772" points="544,161.3672,554,165.3672,544,169.3672,548,165.3672" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="305" x2="550" y1="165.3672" y2="165.3672"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="312" y="144.1592">pm_policy_state_lock_get</text><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="312" y="160.5107">(PM_STATE_RUNTIME_IDLE)</text><polygon fill="#F05772" points="316,175.3672,306,179.3672,316,183.3672,312,179.3672" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="310" x2="560" y1="179.3672" y2="179.3672"/><polygon fill="#F05772" points="61,189.3672,51,193.3672,61,197.3672,57,193.3672" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55" x2="299" y1="193.3672" y2="193.3672"/><rect fill="#EEEEEE" filter="url(#f1qyth8cbm2pf7)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1051.5" x="3" y="229.543"/><line style="stroke: #D6D6DE; stroke-width: 0.5;" x1="3" x2="1054.5" y1="229.543" y2="229.543"/><line style="stroke: #D6D6DE; stroke-width: 0.5;" x1="3" x2="1054.5" y1="232.543" y2="232.543"/><rect fill="#EEEEEE" filter="url(#f1qyth8cbm2pf7)" height="24.3516" style="stroke: #D6D6DE; stroke-width: 1.0;" width="213" x="422.25" y="218.3672"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="428.25" y="235.8623">DSP FW in PM_STATE_ACTIVE</text><polygon fill="#F05772" points="283,271.0703,293,275.0703,283,279.0703,287,275.0703" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="50" x2="289" y1="275.0703" y2="275.0703"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="57" y="270.2139">SET_DX(PID: Core #0, D3) IPC request</text><polygon fill="#F05772" points="544,301.4219,554,305.4219,544,309.4219,548,305.4219" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="305" x2="550" y1="305.4219" y2="305.4219"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="312" y="300.5654">Read status of secondary cores</text><polygon fill="#F05772" points="316,315.4219,306,319.4219,316,323.4219,312,319.4219" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="310" x2="560" y1="319.4219" y2="319.4219"/><path d="M13,334.4219 L74,334.4219 L74,342.4219 L64,352.4219 L13,352.4219 L13,334.4219 " fill="#EEEEEE" style="stroke: #A1A1CA; stroke-width: 1.0;"/><rect fill="none" height="303" style="stroke: #A1A1CA; stroke-width: 2.0;" width="960" x="13" y="334.4219"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="28" y="348.917">alt</text><text fill="#33335B" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="89" y="347.8408">[If any secondary core is powered up]</text><polygon fill="#F05772" points="61,371.125,51,375.125,61,379.125,57,375.125" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55" x2="294" y1="375.125" y2="375.125"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="67" y="370.2686">SET_DX(ERROR) IPC response</text><line style="stroke: #A1A1CA; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="13" x2="973" y1="384.125" y2="384.125"/><text fill="#33335B" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="18" y="395.5439">[else]</text><polygon fill="#F05772" points="544,433.6641,554,437.6641,544,441.6641,548,437.6641" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="305" x2="550" y1="437.6641" y2="437.6641"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="312" y="416.4561">pm_power_state_force</text><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="312" y="432.8076">(PM_STATE_SOFT_OFF, PID: Core #0)</text><polygon fill="#F05772" points="805,480.3672,815,484.3672,805,488.3672,809,484.3672" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="566" x2="811" y1="484.3672" y2="484.3672"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="573" y="463.1592">pm_power_state_set</text><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="573" y="479.5107">(PM_STATE_SOFT_OFF, PID: Core #0)</text><line style="stroke: #F05772; stroke-width: 1.0;" x1="827" x2="869" y1="514.7188" y2="514.7188"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="869" x2="869" y1="514.7188" y2="527.7188"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="828" x2="869" y1="527.7188" y2="527.7188"/><polygon fill="#F05772" points="838,523.7188,828,527.7188,838,531.7188,834,527.7188" style="stroke: #F05772; stroke-width: 1.0;"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="834" y="509.8623">Save context</text><line style="stroke: #F05772; stroke-width: 1.0;" x1="827" x2="869" y1="558.0703" y2="558.0703"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="869" x2="869" y1="558.0703" y2="571.0703"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="828" x2="869" y1="571.0703" y2="571.0703"/><polygon fill="#F05772" points="838,567.0703,828,571.0703,838,575.0703,834,571.0703" style="stroke: #F05772; stroke-width: 1.0;"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="834" y="553.2139">Prepare restore vector</text><polygon fill="#F05772" points="577,581.0703,567,585.0703,577,589.0703,573,585.0703" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="571" x2="821" y1="585.0703" y2="585.0703"/><polygon fill="#F05772" points="316,595.0703,306,599.0703,316,603.0703,312,599.0703" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="310" x2="560" y1="599.0703" y2="599.0703"/><polygon fill="#F05772" points="61,625.4219,51,629.4219,61,633.4219,57,629.4219" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55" x2="299" y1="629.4219" y2="629.4219"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="67" y="624.5654">SET_DX(SUCCESS) IPC response</text><polygon fill="#F05772" points="961,662.7734,971,666.7734,961,670.7734,965,666.7734" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="50" x2="967" y1="666.7734" y2="666.7734"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="57" y="661.917">clear power register</text><path d="M13,681.7734 L86,681.7734 L86,689.7734 L76,699.7734 L13,699.7734 L13,681.7734 " fill="#EEEEEE" style="stroke: #A1A1CA; stroke-width: 1.0;"/><rect fill="none" height="48.7031" style="stroke: #A1A1CA; stroke-width: 2.0;" width="1031.5" x="13" y="681.7734"/><text fill="#33335B" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="28" y="696.2686">loop</text><text fill="#33335B" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="101" y="695.1924">[Until Core #0 power is down]</text><polygon fill="#F05772" points="961,718.4766,971,722.4766,961,726.4766,965,722.4766" style="stroke: #F05772; stroke-width: 1.0;"/><line style="stroke: #F05772; stroke-width: 1.0;" x1="50" x2="967" y1="722.4766" y2="722.4766"/><text fill="#33335B" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="57" y="717.6201">Read Core #0 power bit</text><!--MD5=[fd5e8dbfdfd97d69d4703254928879ee]
@startuml
hidefootbox
skinparam componentStyle uml2

skinparam defaultFontColor	#33335b

skinparam rectangle {
	color		#d6d6de
	backgroundColor	#ffffff
}

skinparam queue {
	color		#d6d6de
	backgroundColor	#ffffff
}

skinparam component {
	backgroundColor	#ffffff
	borderColor	#33335b
	arrowColor	#f05772
}

skinparam interface {
	backgroundColor	#ffffff
	borderColor	#f05772
}

skinparam class {
	backgroundColor	#ffffff
	borderColor	#33335b
	arrowColor	#f05772
}
skinparam stereotypeCBackgroundColor	#6fccdd

skinparam sequence {
	arrowColor		#4a4a86
	lifeLineBorderColor	#f05772
	groupBorderColor	#a1a1ca
	boxBorderColor		#a1a1ca
	dividerBorderColor	#d6d6de
	dividerBorderThickness	1
}
skinparam participant {
	borderColor		#33335b
	backgroundColor		#ffffff
}
skinparam actor {
	borderColor		#33335b
	backgroundColor		#ffffff
}

skinparam state {
	borderColor		#33335b
	backgroundColor		#ffffff
}

skinparam node {
	backgroundColor		#ffffff
}

skinparam note {
	backgroundColor 	#f6ed80
	borderColor		#d6d6de
}

skinparam activity {
	borderColor		#33335b
	backgroundColor		#ffffff
}

skinparam activityDiamond {
	borderColor		#33335b
	backgroundColor		#ffffff
}

skinparam arrowColor	#f05772
skinparam maxMessageSize 400
skinparam BoxPadding 4

scale max 1280 width

box "Host" #LightSkyBlue
	participant "driver" as driver
end box

box "SOF" #LightBlue
	participant "Core #0: Zephyr lib" as sof_zephyr_lib_0
	participant "Zephyr Power Manager" as zephyr_power_manager
	participant "Zephyr SoC HAL" as soc_hal
end box

box "Hardware" #LightGreen
	participant "Core #0: Control" as core_hw_control
end box

opt If D0ix is enabled
	driver -> sof_zephyr_lib_0: SET_D0ix(prevent D0ix) IPC request
	activate sof_zephyr_lib_0
		sof_zephyr_lib_0 -> zephyr_power_manager: pm_policy_state_lock_get\n(PM_STATE_RUNTIME_IDLE)
		activate zephyr_power_manager
		return
	return
end

== DSP FW in PM_STATE_ACTIVE ==

driver -> sof_zephyr_lib_0: SET_DX(PID: Core #0, D3) IPC request
activate sof_zephyr_lib_0
	sof_zephyr_lib_0 -> zephyr_power_manager: Read status of secondary cores
	activate zephyr_power_manager
		return

	alt If any secondary core is powered up
		sof_zephyr_lib_0 - -> driver: SET_DX(ERROR) IPC response
	else else
		sof_zephyr_lib_0 -> zephyr_power_manager: pm_power_state_force\n(PM_STATE_SOFT_OFF, PID: Core #0)
		activate zephyr_power_manager
			zephyr_power_manager -> soc_hal: pm_power_state_set\n(PM_STATE_SOFT_OFF, PID: Core #0)
			activate soc_hal
				soc_hal -> soc_hal: Save context
				soc_hal -> soc_hal: Prepare restore vector
			return
		return

return SET_DX(SUCCESS) IPC response
end

driver -> core_hw_control: clear power register
loop Until Core #0 power is down
	driver -> core_hw_control: Read Core #0 power bit
end

@enduml

PlantUML version 1.2019.12(Sun Nov 03 11:24:54 CET 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_302-b08
Operating System: Windows 10
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>