.. _sof_doc:

SOF Documentation Generation
############################

These instructions will walk you through generating the SOF Project's
documentation and publishing it to https://thesofproject.github.io.
You can also use these instructions to generate the ARCN documentation
on your local system.

Documentation overview
**********************

The SOF Project content is written using the reStructuredText markup
language (.rst file extension) with Sphinx extensions, and processed
using Sphinx to create a formatted standalone website. Developers can
view this content either in its raw form as .rst markup files, or you
can generate the HTML content and view it with a web browser directly on
your workstation.

You can read details about `reStructuredText`_, and `Sphinx`_ from
their respective websites.

The project's documentation contains the following items:

* ReStructuredText source files used to generate documentation found at the
  http://thesofproject.github.io website. All of the reStructuredText sources
  are found in this thesofproject/sof-docs repo.

The reStructuredText files are processed by the Sphinx documentation system,
and make use of the breathe extension for including the doxygen-generated API
material.


Set up documentation working folders
************************************

You must install git to set up the working folders:

* For an Ubuntu development system use:

  .. code-block:: bash

     sudo apt-get install git

* For a Fedora development system use:

  .. code-block:: bash

     sudo dnf install git

We use github.io
for publishing the generated documentation.
The recommended folder setup for documentation contributions and
generation is as follows:

.. code-block: console

   thesofproject/
      sof/
      sof-docs/

The parent ``thesofproject`` folder is present because we use the
publishing area (``thesofproject.github.io``) later in these steps.  It's
best if the ``sof-docs`` folder is an ssh clone of your personal fork of the
upstream project repos (although https clones also work):

#. Use your browser to visit https://github.com/thesofproject and do a
   fork of the ``sof-docs`` repo to your personal GitHub account.)

   .. image:: images/fork-sof-docs.png

#. At a command prompt, create the working folder and clone the sof-docs
   repository to your local computer (and if you have publishing rights, the
   thesofproject.github.io repo).  If you don't have publishing rights,
   can still generate the docs locally but not publish them:

   .. code-block:: bash

      cd ~
      mkdir thesofproject && cd thesofproject
      git clone git@github.com:<github-username>/thesofproject/sof-docs.git

#. The documentation of the sof source code generated by doxygen is referenced
   and included by the sof-docs. Clone the sof repository, too:

   .. code-block:: bash

      git clone git@github.com:thesofproject/sof.git
      # use next until merged back to master
      cd sof
      git checkout next
      cd ..

#. For the cloned local repos, tell git about the upstream repo:

   .. code-block:: bash

      cd sof-docs
      git remote add upstream git@github.com:thesofproject/sof-docs.git

#. If you haven't done so already, be sure to configure git with your name
   and email address for the signed-off-by line in your commit messages:

   .. code-block:: bash

      git config --global user.name "David Developer"
      git config --global user.email "david.developer@company.com"

Install documentation tools
***************************

Our documentation processing has been tested to run with:

* Python 3.6.3
* Doxygen version 1.8.13
* Sphinx version 1.7.5
* Breathe version 4.9.1
* docutils version 0.14
* sphinx_rtd_theme version 0.4.0

The SOF documentation makes use of additional Sphinx extensions used for
creating drawings:

* sphinxcontrib-plantuml
* sphinx.ext.graphviz  (included with Sphinx)

.. note::  The plantuml extension uses Java to render the uml drawing
   syntax into an image. You'll need to have a Java runtime environment
   (JRE) installed when generating documentation.

Depending on your Linux version, install the needed tools:

* For Ubuntu use:

  .. code-block:: bash

     sudo apt-get install doxygen python3-pip python3-wheel make \
        default-jre graphviz

* For Fedora use:

  .. code-block:: bash

     sudo dnf install doxygen python3-pip python3-wheel make \
        default-jre graphviz

And for either Linux environment, install the remaining python-based
tools:

.. code-block:: bash

   cd ~/thesofproject/sof-docs
   pip3 install --user -r scripts/requirements.txt

And with that you're ready to generate the documentation.

Documentation presentation theme
********************************

Sphinx supports easy customization of the generated documentation
appearance through the use of themes. Replace the theme files and do
another ``make html`` and the output layout and style is changed.
The ``read-the-docs`` theme is installed as part of the
``requirements.txt`` list above.

Run documentation processors
****************************

The sof-docs directory has all the .rst source files, extra tools, and Makefile
for generating a local copy of the SOF technical documentation.

.. code-block:: bash

   cd ~/thesofproject/sof/doc
   cmake .
   make doc

   cd ~/thesofproject/sof-docs
   make html

Depending on your development system, it will take about 10 seconds to collect
and generate the HTML content. When done, you can view the HTML output with
your browser started at ``~/thesofproject/sof-docs/_build/html/index.html``

Publish content
***************

If you have merge rights to the thesofproject repo called
thesofproject.github.io, you can update the public project documentation
found at https://thesofproject.github.io.

You'll need to do a one-time clone of the upstream repo (we publish
directly to the upstream repo rather than to a personal forked copy):

.. code-block:: bash

   cd ~/thesofproject
   git clone git@github.com:thesofproject/thesofproject.github.io.git

Then, after you've verified that the generated HTML from ``make html`` looks
good, you can push directly to the publishing site with:

.. code-block:: bash

   make publish

This will delete everything in the publishing repo's **latest** folder (in case
the new version has deleted files) and push a copy of the newly-generated HTML
content directly to the GitHub pages publishing repo. The public site at
https://thesofproject.github.io will be updated within a few minutes so it's
best to verify the locally generated html before publishing.

.. note::
   In some situations it is necessary to clean all the files and build from the very
   beginning. 'make clean' command may be helpful.

Installation troubleshooting
****************************

In some cases, you cannot run the documentation processors due to the following
errors:

.. code-block:: bash

	make html

.. code-block:: console

	Warning: sphinx_rtd_theme missing. Use pip to install it.
	Extension error:
	Could not import extension breathe (exception: No module named breathe)
	Makefile:36: recipe for target 'html' failed
	make: *** [html] Error 1

The issue could be related to the default policy on Debian-based Linux
distributions (i.e. Ubuntu) that links Python commands to Python 2.7.x. You can
verify this by entering the following steps:

.. code-block:: bash

	python --version

.. code-block:: console

	Python 2.7.15rc1


.. code-block:: bash

	ll /usr/bin/python

.. code-block:: console

	lrwxrwxrwx 1 root root 9 sie 29 07:36 /usr/bin/python -> python2.7*

The issue can be resolved by running a dedicated environment with the Python
3.x binary and include its own set of installed Python packages. Virtualization
of the Python environment is recommended as an alternative to:

* adding an alias setup in ~/.bashrc
* changing the symbolic link (/usr/bin/python)
* modifying the default system behavior using update-alternatives

Start with installing virtualization support. As a next step, activate the
virtualized environment.

.. code-block:: bash

	apt-get install python3-venv
	python3 -m venv my-sof-env
	. ./my-sof-env/bin/activate
	python --version

.. code-block:: console

	Python 3.6.7

You can verify the Python version and proceed with installing all required
Python packages in the virtualized environment.

.. code-block:: bash

	pip install sphinx
	git clone https://github.com/thesofprojects/sof.git
	git clone https://github.com/thesofprojects/sof-docs.git
	cd sof-docs/
	pip install -r scripts/requirements.txt

After the installation is finished, you should be able to generate
documentation invoking commands listed in "Running the documentation
processors".

To deactivate virtual environment and original Python environment type:

.. code-block:: bash

	deactivate

Further information on how to use lightweight Python
virtualization environments can be found at
https://docs.python.org/3/library/venv.html.

Diagram compilation troubleshooting
***********************************

In case you are creating a diagram that is using the lastest features of
plantuml, you may encounter the following compilation error:

.. code-block:: console

	WARNING: error while running plantuml
	b'ERROR\n2\nSyntax Error?\nSome diagram description contains errors\n'

If you excluded syntax errors in the diagram description, one of remaining
possibilities is lack of compatibility with the installed plantuml.jar version.
You can verify it using the following command:

.. code-block:: bash

	java -jar ./scripts/plantuml.jar -version

If the installed version of plantuml.jar is missing necessary features, submit
a pull request to the SOF documentation repository with the new one.


.. _reStructuredText: http://sphinx-doc.org/rest.html
.. _Sphinx: http://sphinx-doc.org/
